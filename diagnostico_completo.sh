#!/bin/bash

echo "+-----------------------------------------------------------+"
echo "¦       DIAGNÓSTICO COMPLETO - CENTRO DIAGNÓSTICO           ¦"
echo "+-----------------------------------------------------------+"
echo ""

# Colores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Función para verificar
check() {
    if [ $1 -eq 0 ]; then
        echo -e "${GREEN}? $2${NC}"
    else
        echo -e "${RED}? $2${NC}"
    fi
}

# 1. Verificar servicios systemd
echo "??????????????????????????????????????????????????????????"
echo "1. SERVICIOS SYSTEMD"
echo "??????????????????????????????????????????????????????????"
systemctl is-active --quiet centro-backend
check $? "Backend service"
systemctl is-active --quiet centro-frontend
check $? "Frontend service"
echo ""

# 2. Verificar puertos
echo "??????????????????????????????????????????????????????????"
echo "2. PUERTOS"
echo "??????????????????????????????????????????????????????????"
nc -zv localhost 5000 2>&1 | grep -q succeeded
check $? "Puerto 5000 (Backend)"
nc -zv localhost 3000 2>&1 | grep -q succeeded
check $? "Puerto 3000 (Frontend)"
echo ""

# 3. Verificar base de datos
echo "??????????????????????????????????????????????????????????"
echo "3. BASE DE DATOS"
echo "??????????????????????????????????????????????????????????"
psql -U centro_user -d centro_diagnostico -c "SELECT 1" &>/dev/null
check $? "Conexión a PostgreSQL"

if [ $? -eq 0 ]; then
    TABLAS=$(psql -U centro_user -d centro_diagnostico -t -c "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public';")
    echo -e "${GREEN}   Tablas encontradas: $TABLAS${NC}"
fi
echo ""

# 4. Verificar archivos críticos
echo "??????????????????????????????????????????????????????????"
echo "4. ARCHIVOS CRÍTICOS"
echo "??????????????????????????????????????????????????????????"
[ -f backend/run.py ]; check $? "backend/run.py"
[ -f backend/app/__init__.py ]; check $? "backend/app/__init__.py"
[ -f backend/config.py ]; check $? "backend/config.py"
[ -f backend/.env ]; check $? "backend/.env"
[ -f frontend/package.json ]; check $? "frontend/package.json"
[ -f frontend/src/App.js ]; check $? "frontend/src/App.js"
[ -d frontend/node_modules ]; check $? "frontend/node_modules/"
echo ""

# 5. Verificar Python virtual environment
echo "??????????????????????????????????????????????????????????"
echo "5. PYTHON ENVIRONMENT"
echo "??????????????????????????????????????????????????????????"
[ -d backend/venv ]; check $? "Virtual environment existe"
[ -f backend/venv/bin/activate ]; check $? "venv activate script"
echo ""

# 6. Verificar rutas y servicios
echo "??????????????????????????????????????????????????????????"
echo "6. MÓDULOS BACKEND"
echo "??????????????????????????????????????????????????????????"
ROUTES=$(ls backend/app/routes/*.py 2>/dev/null | wc -l)
SERVICES=$(ls backend/app/services/*.py 2>/dev/null | wc -l)
echo -e "${GREEN}   Rutas: $ROUTES archivos${NC}"
echo -e "${GREEN}   Servicios: $SERVICES archivos${NC}"
echo ""

# 7. Verificar componentes frontend
echo "??????????????????????????????????????????????????????????"
echo "7. COMPONENTES FRONTEND"
echo "??????????????????????????????????????????????????????????"
COMPONENTS=$(ls frontend/src/components/*.js 2>/dev/null | wc -l)
echo -e "${GREEN}   Componentes React: $COMPONENTS archivos${NC}"
echo ""

# 8. Probar endpoints
echo "??????????????????????????????????????????????????????????"
echo "8. ENDPOINTS HTTP"
echo "??????????????????????????????????????????????????????????"
curl -s http://localhost:5000/api/health &>/dev/null
check $? "Backend Health Check (http://localhost:5000/api/health)"
curl -s http://localhost:3000 &>/dev/null
check $? "Frontend (http://localhost:3000)"
echo ""

# 9. Espacio en disco
echo "??????????????????????????????????????????????????????????"
echo "9. RECURSOS DEL SISTEMA"
echo "??????????????????????????????????????????????????????????"
DISK=$(df -h / | awk 'NR==2 {print $5}' | sed 's/%//')
if [ $DISK -lt 80 ]; then
    echo -e "${GREEN}? Espacio en disco: ${DISK}% usado${NC}"
else
    echo -e "${RED}? Espacio en disco: ${DISK}% usado (CRÍTICO)${NC}"
fi

MEM=$(free | grep Mem | awk '{printf("%.0f", $3/$2 * 100)}')
echo -e "${GREEN}   Memoria RAM: ${MEM}% usado${NC}"
echo ""

# 10. Resumen final
echo "+-----------------------------------------------------------+"
echo "¦                    RESUMEN FINAL                          ¦"
echo "+-----------------------------------------------------------+"
echo ""
echo "URLs del sistema:"
echo "  Frontend: http://192.9.135.84:3000"
echo "  Backend:  http://192.9.135.84:5000"
echo "  Health:   http://192.9.135.84:5000/api/health"
echo ""
echo "Para ver logs en tiempo real:"
echo "  Backend:  sudo journalctl -u centro-backend -f"
echo "  Frontend: sudo journalctl -u centro-frontend -f"
echo ""
